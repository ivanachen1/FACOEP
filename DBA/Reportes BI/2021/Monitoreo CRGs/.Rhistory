proveedorprestador pp ON pp.pprid = det.pprid
LEFT JOIN(
SELECT
cd.comprobantepprid,
pprnombre as Efector,
cd.tipocomprobantecodigo as tipocomprobante,
CAST(cd.tipocomprobantecodigo AS TEXT) || ' - ' || CAST(cd.comprobanteprefijo AS TEXT) || ' - ' ||CAST(cd.comprobantecodigo AS TEXT) as factura,
cd.comprobantecrgdetpractica as Prestacion,
cd.comprobantecrgnro,
crg.crgfchemision,
cd.comprobantecrgdetimportecrg as ImporteCRG
FROM comprobantecrgdet cd
LEFT JOIN
crg ON cd.comprobantecrgnro = crg.crgnum and crg.pprid = cd.comprobantepprid
LEFT JOIN
proveedorprestador pp ON pp.pprid = cd.comprobantepprid
) as aux
ON det.pprid = aux.comprobantepprid AND det.crgnum = aux.comprobantecrgnro
WHERE det.crgdetpractica IN ({prestaciones}) AND aux.tipocomprobante IN ({comprobantes}) AND aux.factura IS NOT NULL")
CRGsFacturados <- dbGetQuery(con,QueryCrgsFacturados)
CRGsFacturados$factura <- gsub(" ","",CRGsFacturados$factura)
CRGsFacturados$prestacion <- gsub(" ","",CRGsFacturados$prestacion)
CRGsFacturados <- select(CRGsFacturados,
"Efector" = efector,
"Factura" = factura,
"Prestacion" = prestacion,
"NroCrg" = nrocrg,
"Fecha Emision CRG" = crgfchemision,
"Importe del CRG" = importecrg,
"Numero DPH" = crgdetnumerocph)
CRGsFacturados <- left_join(CRGsFacturados,PrestacionesNosumar,by = c("Prestacion" = "Prestacion"))
CRGsFacturados$Sumar[is.na(CRGsFacturados$Sumar)] <- TRUE
View(CRGsFacturados)
source("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/Cobranzas/Versión 7"
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
host <-GetHost(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = "facoep",
host = host, port = 5432,
user = user,password = pw)
PrestacionesNosumar <- GetFile("PrestacionesNoSumar.xlsx",
path_one = path_one,
path_two = path_two)
EstadosCrgs <- GetFile("Estados CRGs.xlsx",
path_one = path_one,
path_two = path_two)
GetDatabase <- function(x = archivo_parametros){
pw <- filter(archivo_parametros,Parametros.servidor == "database")
pw <- filter(pw,Usar == TRUE)
pw <- pw$Valor
return(pw)
}
database <- GetDatabase(x = archivo_parametros)
source("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/Cobranzas/Versión 7"
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
database <- GetDatabase(x = archivo_parametros)
setwd("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs")
setwd("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs")
setwd("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/")
SetWorkDirectory<- function(path_one,path_two){
intento <- is.error(try(setwd(path_two),silent = F,outFile = "Error"))
if(intento == TRUE){
setwd(path_one)} else {setwd(path_two)}
}
SetWorkDirectory(path_one = path_one,
path_two = path_two)
############################################ LIBRERIAS ########################################################
library(data.table)
library(tidyverse)
library(stringr)
library(openxlsx)
library(scales)
library(formattable)
library(stringr)
library(plyr)
library(zoo)
library("RPostgreSQL")
library(lubridate)
library(glue)
SetWorkDirectory(path_one = path_one,
path_two = path_two)
setwd("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs")
setwd("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/")
source("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
SetWorkDirectory(path_one = path_one,
path_two = path_two)
library(BBmisc)
intento <- is.error(try(setwd(path_two),silent = F,outFile = "Error"))
SetWorkDirectory<- function(path_one,path_two){
intento <- is.error(try(setwd(path_two),silent = F,outFile = "Error"))
if(intento == TRUE){
setwd(path_one)} else {setwd(path_two)}
}
SetWorkDirectory(path_one = path_one,
path_two = path_two)
setwd("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs")
setwd("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/")
source("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
SetWorkDirectory(path_one = path_one,
path_two = path_two)
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
database <- GetDatabase(x = archivo_parametros)
host <-GetHost(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
print(con)
workdirectory <- GetWorkDirectory(x = archivo_parametros)
print(paste(workdirectory,"Prestaciones Nancy.xlsx"))
separador <- ("/")
prestaciones <- read.xlsx(paste(workdirectory,"Prestaciones Nancy.xlsx",sep = separador))
GrupoPrestaciones <- prestaciones
prestaciones <- prestaciones$Prestacion
prestaciones <- unique(prestaciones)
prestaciones <- as.vector(prestaciones)
prestaciones <- unique(prestaciones)
prestaciones <- toString(sprintf("'%s'", prestaciones))
print(prestaciones)
PrestacionesNosumar <- GetFile("PrestacionesNoSumar.xlsx",
path_one = path_one,
path_two = path_two)
QueryDetalleCrg <- glue("SELECT det.pprid,
pp.pprnombre as efector,
det.crgnum as Nrocrg,
os.obsocialesdescripcion,
det.crgdetnumerocph,
det.crgdetpractica as practica,
det.crgdetid as idpractica,
det.crgdetimportecrg as importecrg,
det.crgdetfechaprestacion as fechaprestacion,
det.crgdetnumerocph as numerodph,
crg.crgfchemision as emisioncrg,
crg.crgestado as crgidestado,
aux2.id_detalle
FROM crgdet det
LEFT JOIN crg
ON det.crgnum = crg.crgnum and crg.pprid = det.pprid
LEFT JOIN
proveedorprestador pp ON pp.pprid = det.pprid
LEFT JOIN
obrassociales os ON crg.obsocialescodigo = os.obsocialescodigo
LEFT JOIN(SELECT DISTINCT
pprid,
crgnum,
CONCAT(pprid ,'-', crgnum) as id_detalle
FROM crgdet det WHERE crgdetpractica IN ({prestaciones})) as aux2
ON CONCAT(det.pprid ,'-', det.crgnum) = aux2.id_detalle
WHERE aux2.id_detalle IS NOT NULL")
CRGDetalle <- dbGetQuery(con,QueryDetalleCrg)
CRGDetalle$practica <- gsub(" ","",CRGDetalle$practica)
CRGDetalle <- left_join(CRGDetalle,PrestacionesNosumar,by = c("practica" = "Prestacion"))
CRGDetalle$Sumar[is.na(CRGDetalle$Sumar)] <- TRUE
CRGDetalle <- select(CRGDetalle,
"Efector" = efector,
"Prestacion" = practica,
"NroCrg" = nrocrg,
"ObraSocial" = obsocialesdescripcion,
"IDPractica" = idpractica,
"Fecha de Prestacion" = fechaprestacion,
"numero de dph" = numerodph,
"Fecha Emision CRG" = emisioncrg,
"EstadoCrg" = crgidestado,
"Importe" = importecrg,
"Id_Detalle" = id_detalle,
"Sumar" = Sumar)
# Cierra todo
lapply(dbListConnections(drv = dbDriver("PostgreSQL")), function(x) {dbDisconnect(conn = x)})
rm(archivo_parametros,con,drv,PrestacionesNosumar,GrupoPrestaciones)
setwd("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs")
setwd("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/")
source("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
SetWorkDirectory(path_one = path_one,
path_two = path_two)
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
database <- GetDatabase(x = archivo_parametros)
host <-GetHost(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
print(con)
workdirectory <- GetWorkDirectory(x = archivo_parametros)
print(paste(workdirectory,"Prestaciones Nancy.xlsx"))
separador <- ("/")
prestaciones <- read.xlsx(paste(workdirectory,"Prestaciones Nancy.xlsx",sep = separador))
GrupoPrestaciones <- prestaciones
prestaciones <- prestaciones$Prestacion
prestaciones <- unique(prestaciones)
prestaciones <- as.vector(prestaciones)
prestaciones <- unique(prestaciones)
prestaciones <- toString(sprintf("'%s'", prestaciones))
print(prestaciones)
PrestacionesNosumar <- GetFile("PrestacionesNoSumar.xlsx",
path_one = path_one,
path_two = path_two)
QueryDetalleCrg <- glue("SELECT det.pprid,
pp.pprnombre as efector,
det.crgnum as Nrocrg,
os.obsocialesdescripcion,
det.crgdetnumerocph,
det.crgdetpractica as practica,
det.crgdetid as idpractica,
det.crgdetimportecrg as importecrg,
det.crgdetfechaprestacion as fechaprestacion,
det.crgdetnumerocph as numerodph,
crg.crgfchemision as emisioncrg,
crg.crgestado as crgidestado,
aux2.id_detalle
FROM crgdet det
LEFT JOIN crg
ON det.crgnum = crg.crgnum and crg.pprid = det.pprid
LEFT JOIN
proveedorprestador pp ON pp.pprid = det.pprid
LEFT JOIN
obrassociales os ON crg.obsocialescodigo = os.obsocialescodigo
LEFT JOIN(SELECT DISTINCT
pprid,
crgnum,
CONCAT(pprid ,'-', crgnum) as id_detalle
FROM crgdet det WHERE crgdetpractica IN ({prestaciones})) as aux2
ON CONCAT(det.pprid ,'-', det.crgnum) = aux2.id_detalle
WHERE aux2.id_detalle IS NOT NULL")
CRGDetalle <- dbGetQuery(con,QueryDetalleCrg)
CRGDetalle$practica <- gsub(" ","",CRGDetalle$practica)
CRGDetalle <- left_join(CRGDetalle,PrestacionesNosumar,by = c("practica" = "Prestacion"))
CRGDetalle$Sumar[is.na(CRGDetalle$Sumar)] <- TRUE
CRGDetalle <- select(CRGDetalle,
"Efector" = efector,
"Prestacion" = practica,
"NroCrg" = nrocrg,
"ObraSocial" = obsocialesdescripcion,
"IDPractica" = idpractica,
"Fecha de Prestacion" = fechaprestacion,
"numero de dph" = numerodph,
"Fecha Emision CRG" = emisioncrg,
"EstadoCrg" = crgidestado,
"Importe" = importecrg,
"Id_Detalle" = id_detalle,
"Sumar" = Sumar)
# Cierra todo
lapply(dbListConnections(drv = dbDriver("PostgreSQL")), function(x) {dbDisconnect(conn = x)})
rm(archivo_parametros,con,drv,PrestacionesNosumar,GrupoPrestaciones)
source("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
SetWorkDirectory(path_one = path_one,
path_two = path_two)
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
database <- GetDatabase(x = archivo_parametros)
host <-GetHost(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
print(con)
workdirectory <- GetWorkDirectory(x = archivo_parametros)
print(paste(workdirectory,"Prestaciones Nancy.xlsx"))
separador <- ("/")
prestaciones <- read.xlsx(paste(workdirectory,"Prestaciones Nancy.xlsx",sep = separador))
GrupoPrestaciones <- prestaciones
prestaciones <- prestaciones$Prestacion
prestaciones <- unique(prestaciones)
prestaciones <- as.vector(prestaciones)
prestaciones <- unique(prestaciones)
prestaciones <- toString(sprintf("'%s'", prestaciones))
print(prestaciones)
PrestacionesNosumar <- GetFile("PrestacionesNoSumar.xlsx",
path_one = path_one,
path_two = path_two)
QueryDetalleCrg <- glue("SELECT det.pprid,
pp.pprnombre as efector,
det.crgnum as Nrocrg,
os.obsocialesdescripcion,
det.crgdetnumerocph,
det.crgdetpractica as practica,
det.crgdetid as idpractica,
det.crgdetimportecrg as importecrg,
det.crgdetfechaprestacion as fechaprestacion,
det.crgdetnumerocph as numerodph,
crg.crgfchemision as emisioncrg,
crg.crgestado as crgidestado,
aux2.id_detalle
FROM crgdet det
LEFT JOIN crg
ON det.crgnum = crg.crgnum and crg.pprid = det.pprid
LEFT JOIN
proveedorprestador pp ON pp.pprid = det.pprid
LEFT JOIN
obrassociales os ON crg.obsocialescodigo = os.obsocialescodigo
LEFT JOIN(SELECT DISTINCT
pprid,
crgnum,
CONCAT(pprid ,'-', crgnum) as id_detalle
FROM crgdet det WHERE crgdetpractica IN ({prestaciones})) as aux2
ON CONCAT(det.pprid ,'-', det.crgnum) = aux2.id_detalle
WHERE aux2.id_detalle IS NOT NULL")
CRGDetalle <- dbGetQuery(con,QueryDetalleCrg)
CRGDetalle$practica <- gsub(" ","",CRGDetalle$practica)
CRGDetalle <- left_join(CRGDetalle,PrestacionesNosumar,by = c("practica" = "Prestacion"))
CRGDetalle$Sumar[is.na(CRGDetalle$Sumar)] <- TRUE
CRGDetalle <- select(CRGDetalle,
"Efector" = efector,
"Prestacion" = practica,
"NroCrg" = nrocrg,
"ObraSocial" = obsocialesdescripcion,
"IDPractica" = idpractica,
"Fecha de Prestacion" = fechaprestacion,
"numero de dph" = numerodph,
"Fecha Emision CRG" = emisioncrg,
"EstadoCrg" = crgidestado,
"Importe" = importecrg,
"Id_Detalle" = id_detalle,
"Sumar" = Sumar)
# Cierra todo
lapply(dbListConnections(drv = dbDriver("PostgreSQL")), function(x) {dbDisconnect(conn = x)})
rm(archivo_parametros,con,drv,PrestacionesNosumar,GrupoPrestaciones)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
drv <- dbDriver("PostgreSQL")
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
# Cierra todo
lapply(dbListConnections(drv = dbDriver("PostgreSQL")), function(x) {dbDisconnect(conn = x)})
rm(archivo_parametros,con,drv,PrestacionesNosumar,GrupoPrestaciones)
source("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
database <- GetDatabase(x = archivo_parametros)
host <-GetHost(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
database <- GetDatabase(x = archivo_parametros)
database <- GetDatabase(x = archivo_parametros)
source("C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
database <- GetDatabase(x = archivo_parametros)
host <-GetHost(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
print(con)
workdirectory <- GetWorkDirectory(x = archivo_parametros)
print(paste(workdirectory,"Prestaciones Nancy.xlsx"))
separador <- ("/")
prestaciones <- read.xlsx(paste(workdirectory,"Prestaciones Nancy.xlsx",sep = separador))
GrupoPrestaciones <- prestaciones
prestaciones <- prestaciones$Prestacion
prestaciones <- unique(prestaciones)
prestaciones <- as.vector(prestaciones)
prestaciones <- unique(prestaciones)
prestaciones <- toString(sprintf("'%s'", prestaciones))
print(prestaciones)
PrestacionesNosumar <- GetFile("PrestacionesNoSumar.xlsx",
path_one = path_one,
path_two = path_two)
QueryDetalleCrg <- glue("SELECT det.pprid,
pp.pprnombre as efector,
det.crgnum as Nrocrg,
os.obsocialesdescripcion,
det.crgdetnumerocph,
det.crgdetpractica as practica,
det.crgdetid as idpractica,
det.crgdetimportecrg as importecrg,
det.crgdetfechaprestacion as fechaprestacion,
det.crgdetnumerocph as numerodph,
crg.crgfchemision as emisioncrg,
crg.crgestado as crgidestado,
aux2.id_detalle
FROM crgdet det
LEFT JOIN crg
ON det.crgnum = crg.crgnum and crg.pprid = det.pprid
LEFT JOIN
proveedorprestador pp ON pp.pprid = det.pprid
LEFT JOIN
obrassociales os ON crg.obsocialescodigo = os.obsocialescodigo
LEFT JOIN(SELECT DISTINCT
pprid,
crgnum,
CONCAT(pprid ,'-', crgnum) as id_detalle
FROM crgdet det WHERE crgdetpractica IN ({prestaciones})) as aux2
ON CONCAT(det.pprid ,'-', det.crgnum) = aux2.id_detalle
WHERE aux2.id_detalle IS NOT NULL")
CRGDetalle <- dbGetQuery(con,QueryDetalleCrg)
CRGDetalle$practica <- gsub(" ","",CRGDetalle$practica)
CRGDetalle <- left_join(CRGDetalle,PrestacionesNosumar,by = c("practica" = "Prestacion"))
CRGDetalle$Sumar[is.na(CRGDetalle$Sumar)] <- TRUE
CRGDetalle <- select(CRGDetalle,
"Efector" = efector,
"Prestacion" = practica,
"NroCrg" = nrocrg,
"ObraSocial" = obsocialesdescripcion,
"IDPractica" = idpractica,
"Fecha de Prestacion" = fechaprestacion,
"numero de dph" = numerodph,
"Fecha Emision CRG" = emisioncrg,
"EstadoCrg" = crgidestado,
"Importe" = importecrg,
"Id_Detalle" = id_detalle,
"Sumar" = Sumar)
# Cierra todo
lapply(dbListConnections(drv = dbDriver("PostgreSQL")), function(x) {dbDisconnect(conn = x)})
rm(archivo_parametros,con,drv,PrestacionesNosumar,GrupoPrestaciones)
View(CRGDetalle)
source("E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs/Script Nancy Logica.R")
path_one <- "C:/Users/iachenbach/Gobierno de la Ciudad de Buenos Aires/Pablo Alfredo Gadea - Tablero Facoep P BI/FACOEP/DBA/Reportes BI/2021/Monitoreo CRGs/"
path_two <- "E:/Personales/Sistemas/Agustin/Reportes BI/2021/MonitoreoCRGs"
archivo_parametros <- GetArchivoParametros(path_one = path_one,path_two = path_two)
pw <- GetPassword(x = archivo_parametros)
drv <- dbDriver("PostgreSQL")
host <-GetHost(x = archivo_parametros)
database <- GetDatabase(x = archivo_parametros)
user <- GetUser(x = archivo_parametros)
con <- dbConnect(drv, dbname = database,
host = host, port = 5432,
user = user,password = pw)
print(con)
workdirectory <- GetWorkDirectory(x = archivo_parametros)
print(paste(workdirectory,"Prestaciones Nancy.xlsx"))
separador <- ("/")
prestaciones <- read.xlsx(paste(workdirectory,"Prestaciones Nancy.xlsx",sep = separador))
GrupoPrestaciones <- prestaciones
prestaciones <- prestaciones$Prestacion
prestaciones <- unique(prestaciones)
prestaciones <- as.vector(prestaciones)
prestaciones <- unique(prestaciones)
prestaciones <- toString(sprintf("'%s'", prestaciones))
PrestacionesNosumar <- GetFile("PrestacionesNoSumar.xlsx",
path_one = path_one,
path_two = path_two)
QueryCrgsSuma <- glue("SELECT det.pprid,
pp.pprnombre as efector,
det.crgnum as Nrocrg,
det.crgdetnumerocph,
os.obsocialesdescripcion,
det.crgdetpractica as practica,
det.crgdetid as idpractica,
det.crgdetimportecrg as importecrg,
det.crgdetfechaprestacion as fechaprestacion,
det.crgdetnumerocph as numerodph,
crg.crgfchemision as emisioncrg,
crg.crgestado as crgidestado,
aux2.id_test,
aux2.id_detalle
FROM crgdet det
LEFT JOIN crg
ON det.crgnum = crg.crgnum and crg.pprid = det.pprid
LEFT JOIN
obrassociales os ON crg.obsocialescodigo = os.obsocialescodigo
LEFT JOIN
proveedorprestador pp ON pp.pprid = det.pprid
LEFT JOIN(SELECT DISTINCT
pprid,
crgnum,
crgdetnumerocph,
CONCAT(pprid ,'-', crgnum,'-',crgdetnumerocph) as id_test,
CONCAT(pprid ,'-', crgnum) as id_detalle
FROM crgdet det WHERE crgdetpractica IN ({prestaciones})) as aux2
ON CONCAT(det.pprid ,'-', det.crgnum,'-',det.crgdetnumerocph) = aux2.id_test
WHERE aux2.id_test IS NOT NULL")
CRGPorEstadosSuma <- dbGetQuery(con,QueryCrgsSuma)
CRGPorEstadosSuma$practica <- gsub(" ","",CRGPorEstadosSuma$practica)
CRGPorEstadosSuma <- unique(CRGPorEstadosSuma)
CRGPorEstadosSuma <- select(CRGPorEstadosSuma,
"Efector" = efector,
"Prestacion" = practica,
"NroCrg" = nrocrg,
"ObraSocial" = obsocialesdescripcion,
"IDPractica" = idpractica,
"Fecha de Prestacion" = fechaprestacion,
"numero de dph" = numerodph,
"Fecha Emision CRG" = emisioncrg,
"EstadoCrg" = crgidestado,
"Importe" = importecrg,
"Id_Test" = id_test,
"Id_Detalle" = id_detalle)
CRGPorEstadosSuma <- left_join(CRGPorEstadosSuma,PrestacionesNosumar,by = c("Prestacion" = "Prestacion"))
CRGPorEstadosSuma$Sumar[is.na(CRGPorEstadosSuma$Sumar)] <- TRUE
#Cierra todo
lapply(dbListConnections(drv = dbDriver("PostgreSQL")), function(x) {dbDisconnect(conn = x)})
rm(archivo_parametros,con,drv,PrestacionesNosumar,GrupoPrestaciones)
View(CRGPorEstadosSuma)
